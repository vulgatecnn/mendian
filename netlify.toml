# Netlify é…ç½®æ–‡ä»¶ - å¥½é¥­ç¢—é—¨åº—ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿ
# å®˜æ–¹æ–‡æ¡£: https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  # æ„å»ºå‘½ä»¤ (è‡ªåŠ¨æ£€æµ‹åŒ…ç®¡ç†å™¨)
  command = """
    if [ -f "pnpm-lock.yaml" ]; then
      echo "ğŸ”§ ä½¿ç”¨ pnpm æ„å»º..."
      npm install -g pnpm
      pnpm install --frozen-lockfile
      if [ -d "frontend" ]; then
        pnpm --filter frontend build || pnpm --filter "*frontend*" build
      else
        pnpm build
      fi
    elif [ -f "yarn.lock" ]; then
      echo "ğŸ”§ ä½¿ç”¨ yarn æ„å»º..."
      yarn install --frozen-lockfile
      yarn build
    else
      echo "ğŸ”§ ä½¿ç”¨ npm æ„å»º..."
      npm ci
      npm run build
    fi
  """
  
  # å‘å¸ƒç›®å½• (è‡ªåŠ¨æ£€æµ‹)
  publish = """
    if [ -d "frontend/dist" ]; then
      echo "frontend/dist"
    elif [ -d "dist" ]; then
      echo "dist"
    elif [ -d "build" ]; then
      echo "build"
    else
      echo "dist"
    fi
  """
  
  # å‡½æ•°ç›®å½• (å¦‚æœä½¿ç”¨ Netlify Functions)
  functions = "netlify/functions"

# ç¯å¢ƒå˜é‡ (ç”Ÿäº§ç¯å¢ƒ)
[build.environment]
  NODE_VERSION = "18"
  NODE_ENV = "production"
  CI = "true"
  NODE_OPTIONS = "--max-old-space-size=4096"
  FORCE_COLOR = "1"
  # æ„å»ºä¼˜åŒ–
  GENERATE_SOURCEMAP = "false"
  # æ—¶åŒº
  TZ = "Asia/Shanghai"

# ============================================================================
# é‡å®šå‘è§„åˆ™ - SPA è·¯ç”±æ”¯æŒ
# ============================================================================

# SPA è·¯ç”±é‡å®šå‘ (React Router, Vue Router ç­‰)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  conditions = {Role = ["admin"], Country = ["us"]}

# API ä»£ç† (å¦‚æœæœ‰åç«¯ API)
[[redirects]]
  from = "/api/*"
  to = "https://your-backend-api.com/api/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}
  
# å¥åº·æ£€æŸ¥ç«¯ç‚¹
[[redirects]]
  from = "/health"
  to = "/.netlify/functions/health"
  status = 200

# æ—§è·¯å¾„é‡å®šå‘
[[redirects]]
  from = "/old-path/*"
  to = "/new-path/:splat"
  status = 301

# ============================================================================
# HTTP å¤´é…ç½® - å®‰å…¨å’Œæ€§èƒ½
# ============================================================================

# å…¨å±€å®‰å…¨å¤´
[[headers]]
  for = "/*"
  [headers.values]
    # å®‰å…¨å¤´
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    
    # CSP (æ ¹æ®éœ€è¦è°ƒæ•´)
    Content-Security-Policy = """
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      img-src 'self' data: https: blob:;
      font-src 'self' https://fonts.gstatic.com;
      connect-src 'self' https://api.github.com wss:;
      media-src 'self';
      object-src 'none';
      frame-ancestors 'none';
      base-uri 'self';
      form-action 'self';
    """

# é™æ€èµ„æºç¼“å­˜
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# HTML æ–‡ä»¶ç¼“å­˜ç­–ç•¥
[[headers]]
  for = "*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Service Worker ç¼“å­˜ç­–ç•¥
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# API å“åº”å¤´
[[headers]]
  for = "/api/*"
  [headers.values]
    Access-Control-Allow-Origin = "https://mendian-app.netlify.app"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"

# ============================================================================
# æ„å»ºæ’ä»¶é…ç½®
# ============================================================================

# åŸºç¡€æ’ä»¶
[[plugins]]
  package = "netlify-plugin-submit-sitemap"
  
  [plugins.inputs]
    baseUrl = "https://mendian-app.netlify.app"
    sitemapPath = "/sitemap.xml"
    providers = [
      "google",
      "bing"
    ]

# å›¾ç‰‡ä¼˜åŒ–
[[plugins]]
  package = "@netlify/plugin-nextjs"

# è¡¨å•å¤„ç†
[[plugins]]
  package = "netlify-plugin-form-submissions"

# PWA æ”¯æŒ (å¦‚æœä½¿ç”¨ PWA)
[[plugins]]
  package = "netlify-plugin-pwa"

# ============================================================================
# åˆ†æ”¯éƒ¨ç½²é…ç½®
# ============================================================================

# ç”Ÿäº§ç¯å¢ƒ (main/master åˆ†æ”¯)
[context.production]
  environment = { NODE_ENV = "production", VITE_APP_ENVIRONMENT = "production" }

# é¢„è§ˆç¯å¢ƒ (develop åˆ†æ”¯)
[context.branch-deploy]
  environment = { NODE_ENV = "staging", VITE_APP_ENVIRONMENT = "staging" }

# Pull Request é¢„è§ˆ
[context.deploy-preview]
  environment = { NODE_ENV = "preview", VITE_APP_ENVIRONMENT = "preview" }

# ç‰¹å®šåˆ†æ”¯é…ç½®
[context."develop"]
  environment = { NODE_ENV = "development", VITE_APP_ENVIRONMENT = "development" }

# ============================================================================
# é«˜çº§é…ç½®
# ============================================================================

# è¾¹ç¼˜å‡½æ•° (Netlify Edge Functions)
# [[edge_functions]]
#   function = "auth"
#   path = "/admin/*"

# A/B æµ‹è¯•
# [[redirects]]
#   from = "/"
#   to = "/variant-a"
#   status = 200
#   conditions = {Role = ["admin"]}

# Prerender (é¢„æ¸²æŸ“)
# [build.processing]
#   skip_processing = false
# [build.processing.css]
#   bundle = true
#   minify = true
# [build.processing.js]
#   bundle = true
#   minify = true
# [build.processing.html]
#   pretty_urls = true

# ============================================================================
# é”™è¯¯é¡µé¢é…ç½®
# ============================================================================

# è‡ªå®šä¹‰ 404 é¡µé¢
# ç¡®ä¿æ‚¨çš„æ„å»ºè¾“å‡ºä¸­åŒ…å« 404.html æ–‡ä»¶