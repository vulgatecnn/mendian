# 门店档案管理模块 - 代码文件清单和API端点定义

## 代码文件结构

### 后端文件清单

#### 1. 数据模型和类型定义
```
backend/src/types/
├── storeFile.ts                 # 门店档案类型定义
└── storeFileOperations.ts       # 门店档案操作类型
```

#### 2. 业务服务层
```
backend/src/services/business/
├── store-file.service.ts        # 门店档案核心业务服务
├── store-document.service.ts    # 门店文档管理服务
└── store-integration.service.ts # 跨模块数据集成服务
```

#### 3. 数据访问层
```
backend/src/repositories/business/
├── store-file.repository.ts     # 门店档案数据访问
└── store-document.repository.ts # 门店文档数据访问
```

#### 4. API控制器
```
backend/src/controllers/v1/
├── store-file.controller.ts     # 门店档案API控制器
└── store-document.controller.ts # 门店文档API控制器
```

#### 5. API路由
```
backend/src/routes/v1/
└── store-files.ts              # 门店档案路由配置（已存在，需完善）
```

#### 6. 测试文件
```
backend/tests/
├── unit/
│   ├── store-file.service.test.ts
│   ├── store-document.service.test.ts
│   └── store-integration.service.test.ts
├── integration/
│   ├── store-file.api.test.ts
│   └── store-document.api.test.ts
└── fixtures/
    └── store-file.fixture.ts
```

### 前端文件清单

#### 1. 页面组件（已存在，需完善）
```
frontend/src/pages/store-files/
├── index.tsx                   # 主入口页面（已存在）
├── StoreList.tsx              # 门店列表页面（已存在，需完善）
├── StoreDetail.tsx            # 门店详情页面（已存在，需完善）
├── StoreHistory.tsx           # 门店历史页面（已存在，需完善）
├── StoreStats.tsx             # 门店统计页面（已存在，需完善）
└── StoreFilesList.tsx         # 门店档案文件列表（已存在，需完善）
```

#### 2. 业务组件
```
frontend/src/components/business/store-files/
├── StoreForm.tsx              # 门店档案表单组件
├── StoreCard.tsx              # 门店卡片组件
├── StoreStatusTag.tsx         # 门店状态标签组件
├── StoreDocumentManager.tsx   # 门店文档管理组件
├── StoreFilterPanel.tsx       # 门店筛选面板组件
├── StoreSearchForm.tsx        # 门店搜索表单组件
├── StoreBatchOperations.tsx   # 门店批量操作组件
└── index.ts                   # 组件导出文件
```

#### 3. API服务层
```
frontend/src/services/api/
├── storeFiles.ts              # 门店档案API服务（已存在，需完善）
└── storeDocuments.ts          # 门店文档API服务（新增）
```

#### 4. 查询Hooks
```
frontend/src/services/query/hooks/
├── useStoreFiles.ts           # 门店档案查询Hook（已存在，需完善）
└── useStoreDocuments.ts       # 门店文档查询Hook（新增）
```

#### 5. 类型定义
```
frontend/src/services/types/
└── storeFiles.ts              # 门店档案前端类型定义（已存在，需完善）
```

#### 6. 测试文件
```
frontend/src/tests/
├── components/
│   ├── StoreForm.test.tsx
│   ├── StoreCard.test.tsx
│   └── StoreDocumentManager.test.tsx
├── pages/
│   ├── StoreList.test.tsx
│   └── StoreDetail.test.tsx
└── services/
    ├── storeFiles.api.test.ts
    └── storeDocuments.api.test.ts
```

### 共享类型定义
```
shared/types/
└── storeFile.ts               # 前后端共享类型定义
```

## API端点定义

### 基础门店档案管理

#### 1. 获取门店档案列表
```
GET /api/v1/store-files
```

**查询参数**：
- `page`: 页码 (默认: 1)
- `limit`: 每页数量 (默认: 20, 最大: 100)
- `search`: 搜索关键词
- `storeType`: 门店类型筛选 (DIRECT, FRANCHISE, FLAGSHIP, POPUP)
- `status`: 门店状态筛选 (PREPARING, OPEN, RENOVATING, SUSPENDED, CLOSED)
- `regionId`: 地区ID筛选
- `entityId`: 主体ID筛选
- `sortBy`: 排序字段 (createdAt, storeName, openDate)
- `sortOrder`: 排序方向 (asc, desc)
- `dateFrom`: 开业日期起始
- `dateTo`: 开业日期结束

**响应示例**：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "store_123",
        "storeCode": "ST001",
        "storeName": "北京朝阳店",
        "storeType": "DIRECT",
        "status": "OPEN",
        "address": "北京市朝阳区...",
        "openDate": "2024-01-15T00:00:00Z",
        "monthlyRevenue": 150000.00,
        "employeeCount": 12,
        "createdAt": "2024-01-01T00:00:00Z",
        "updatedAt": "2024-01-15T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 156,
      "totalPages": 8
    },
    "summary": {
      "totalStores": 156,
      "openStores": 142,
      "preparingStores": 14
    }
  },
  "message": "获取门店档案列表成功"
}
```

#### 2. 获取门店档案详情
```
GET /api/v1/store-files/:id
```

**路径参数**：
- `id`: 门店档案ID

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": "store_123",
    "storeCode": "ST001",
    "storeName": "北京朝阳店",
    "storeType": "DIRECT",
    "brandName": "好饭碗",
    "status": "OPEN",
    "address": "北京市朝阳区...",
    "detailedAddress": "朝阳区建国路88号现代城A座1层",
    "area": 200.5,
    "usableArea": 180.0,
    "floors": 1,
    "seatCount": 80,
    "openDate": "2024-01-15T00:00:00Z",
    "businessLicense": "91110000123456789X",
    "licenseExpiry": "2025-12-31T00:00:00Z",
    "coordinates": "116.4074,39.9042",
    "monthlyRevenue": 150000.00,
    "monthlyRent": 25000.00,
    "employeeCount": 12,
    "operatingHours": {
      "monday": {"open": "09:00", "close": "22:00"},
      "tuesday": {"open": "09:00", "close": "22:00"}
    },
    "franchiseeInfo": null,
    "managementTeam": [
      {
        "name": "张经理",
        "position": "店长",
        "phone": "13800138001"
      }
    ],
    "photos": [
      "https://oss.example.com/store/photo1.jpg"
    ],
    "documents": [
      {
        "type": "营业执照",
        "url": "https://oss.example.com/store/license.pdf",
        "uploadDate": "2024-01-01T00:00:00Z"
      }
    ],
    "relatedData": {
      "candidateLocation": {...},
      "constructionProjects": [...],
      "paymentItems": [...]
    },
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-15T00:00:00Z"
  },
  "message": "获取门店档案详情成功"
}
```

#### 3. 创建门店档案
```
POST /api/v1/store-files
```

**请求体**：
```json
{
  "candidateLocationId": "location_456",
  "entityId": "entity_789",
  "storeName": "上海浦东店",
  "storeType": "FRANCHISE",
  "brandName": "好饭碗",
  "address": "上海市浦东新区...",
  "area": 180.0,
  "seatCount": 60,
  "franchiseeInfo": {
    "name": "李先生",
    "phone": "13900139001",
    "idCard": "310101199001010001"
  },
  "operatingHours": {...},
  "managementTeam": [...]
}
```

#### 4. 更新门店档案
```
PUT /api/v1/store-files/:id
PATCH /api/v1/store-files/:id  // 部分更新
```

#### 5. 删除门店档案（软删除）
```
DELETE /api/v1/store-files/:id
```

#### 6. 批量操作门店档案
```
POST /api/v1/store-files/batch
```

**请求体**：
```json
{
  "action": "update_status",  // update_status, export, delete
  "storeIds": ["store_123", "store_456"],
  "data": {
    "status": "SUSPENDED"
  }
}
```

### 门店状态管理

#### 7. 更新门店状态
```
PATCH /api/v1/store-files/:id/status
```

**请求体**：
```json
{
  "status": "OPEN",
  "reason": "装修完成，正式开业",
  "effectiveDate": "2024-02-01T00:00:00Z"
}
```

#### 8. 获取门店状态历史
```
GET /api/v1/store-files/:id/status-history
```

### 门店文档管理

#### 9. 获取门店文档列表
```
GET /api/v1/store-files/:id/documents
```

**查询参数**：
- `category`: 文档分类 (license, contract, photo, floorplan, other)

#### 10. 上传门店文档
```
POST /api/v1/store-files/:id/documents
Content-Type: multipart/form-data
```

**表单数据**：
- `file`: 文件内容
- `category`: 文档分类
- `description`: 文档描述

#### 11. 删除门店文档
```
DELETE /api/v1/store-files/:id/documents/:documentId
```

#### 12. 下载门店文档
```
GET /api/v1/store-files/:id/documents/:documentId/download
```

### 门店数据集成

#### 13. 从候选点位创建门店档案
```
POST /api/v1/store-files/create-from-location/:locationId
```

#### 14. 同步工程项目数据
```
POST /api/v1/store-files/:id/sync-construction-data
```

#### 15. 获取门店关联数据
```
GET /api/v1/store-files/:id/related-data
```

**查询参数**：
- `include`: 包含的关联数据类型 (location, construction, payments, approvals)

### 门店统计和报表

#### 16. 获取门店统计数据
```
GET /api/v1/store-files/statistics
```

**查询参数**：
- `groupBy`: 分组维度 (storeType, status, region, entity)
- `dateRange`: 时间范围
- `regionId`: 地区筛选

**响应示例**：
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalStores": 156,
      "openStores": 142,
      "preparingStores": 14,
      "totalRevenue": 21500000.00,
      "averageRevenue": 151408.45
    },
    "byStoreType": [
      {
        "storeType": "DIRECT",
        "count": 89,
        "revenue": 13450000.00
      },
      {
        "storeType": "FRANCHISE",
        "count": 67,
        "revenue": 8050000.00
      }
    ],
    "byStatus": [...],
    "byRegion": [...],
    "trendData": [
      {
        "month": "2024-01",
        "newStores": 5,
        "totalRevenue": 2100000.00
      }
    ]
  }
}
```

#### 17. 导出门店档案数据
```
POST /api/v1/store-files/export
```

**请求体**：
```json
{
  "format": "excel",  // excel, csv, pdf
  "filters": {
    "storeType": ["DIRECT"],
    "status": ["OPEN"],
    "dateRange": {
      "from": "2024-01-01",
      "to": "2024-12-31"
    }
  },
  "fields": ["storeName", "address", "openDate", "monthlyRevenue"],
  "groupBy": "region"
}
```

### 权限控制

所有API端点都需要通过以下权限验证：

| 端点 | 权限代码 | 说明 |
|------|---------|------|
| GET /store-files | store-files:read | 查看门店档案 |
| POST /store-files | store-files:create | 创建门店档案 |
| PUT /store-files/:id | store-files:update | 更新门店档案 |
| DELETE /store-files/:id | store-files:delete | 删除门店档案 |
| POST /store-files/:id/documents | store-files:manage-documents | 管理门店文档 |
| GET /store-files/statistics | store-files:view-statistics | 查看统计数据 |
| POST /store-files/export | store-files:export | 导出数据 |

## 错误处理规范

### 标准错误响应格式
```json
{
  "success": false,
  "error": {
    "code": "STORE_FILE_NOT_FOUND",
    "message": "指定的门店档案不存在",
    "details": {
      "storeId": "store_123",
      "requestId": "req_789"
    }
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### 常见错误代码
- `STORE_FILE_NOT_FOUND` - 门店档案不存在
- `INVALID_STORE_STATUS` - 无效的门店状态
- `DUPLICATE_STORE_CODE` - 门店编码重复
- `INSUFFICIENT_PERMISSIONS` - 权限不足
- `VALIDATION_ERROR` - 数据验证失败
- `UPLOAD_FILE_TOO_LARGE` - 上传文件过大
- `UNSUPPORTED_FILE_TYPE` - 不支持的文件类型

## 数据验证规则

### 门店档案字段验证
```typescript
const storeFileValidation = {
  storeName: {
    required: true,
    maxLength: 200,
    pattern: /^[\u4e00-\u9fa5a-zA-Z0-9\s\-()（）]+$/
  },
  storeCode: {
    required: true,
    maxLength: 50,
    pattern: /^[A-Z0-9]+$/,
    unique: true
  },
  address: {
    required: true,
    maxLength: 500
  },
  area: {
    type: 'number',
    min: 10,
    max: 10000
  },
  seatCount: {
    type: 'number',
    min: 1,
    max: 1000
  },
  monthlyRevenue: {
    type: 'number',
    min: 0,
    max: 999999999.99
  }
}
```

## 性能优化策略

### 数据库查询优化
1. **索引优化**：
   - 复合索引：(entityId, status, storeType)
   - 全文搜索索引：(storeName, address)
   - 时间范围索引：(openDate, createdAt)

2. **查询优化**：
   - 使用分页避免大量数据加载
   - 实施查询结果缓存
   - 优化JOIN查询，避免N+1问题

3. **缓存策略**：
   - Redis缓存热门门店数据
   - 统计数据缓存5分钟
   - 文档URL缓存1小时

### 前端性能优化
1. **组件优化**：
   - 使用React.memo避免不必要重渲染
   - 实施虚拟滚动处理大列表
   - 图片懒加载和压缩

2. **数据加载优化**：
   - 分页加载和无限滚动
   - 预加载常用数据
   - 实施客户端缓存策略

---

*此代码文件清单和API定义将确保门店档案管理模块的标准化开发和高质量实现*