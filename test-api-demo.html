<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯APIè°ƒç”¨æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        .service-status {
            padding: 15px 25px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .running {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .stopped {
            background-color: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #262626;
            margin-top: 0;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .result {
            background-color: #fafafa;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #52c41a;
            background-color: #f6ffed;
        }
        .error {
            border-color: #ff4d4f;
            background-color: #fff2f0;
        }
        .loading {
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é—¨åº—ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿ - APIè°ƒç”¨æ¼”ç¤º</h1>
        
        <div class="status">
            <div class="service-status running">
                âœ… åç«¯æœåŠ¡: http://localhost:5100
            </div>
            <div class="service-status running">
                âœ… å‰ç«¯æœåŠ¡: http://localhost:5000
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” è®¤è¯æœåŠ¡æµ‹è¯•</h3>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
            <div id="auth-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†æµ‹è¯•</h3>
            <button onclick="testGetUsers()">è·å–ç”¨æˆ·åˆ—è¡¨</button>
            <button onclick="testGetDepartments()">è·å–éƒ¨é—¨åˆ—è¡¨</button>
            <div id="user-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸª ä¸šåŠ¡æ•°æ®æµ‹è¯•</h3>
            <button onclick="testGetRegions()">è·å–ç»è¥åŒºåŸŸ</button>
            <button onclick="testGetPlans()">è·å–å¼€åº—è®¡åˆ’</button>
            <button onclick="testGetLocations()">è·å–å€™é€‰ç‚¹ä½</button>
            <div id="business-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <button onclick="testSystemHealth()">ç³»ç»Ÿå¥åº·æ£€æŸ¥</button>
            <div id="system-result" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = null;

        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };
            
            const response = await fetch(`http://localhost:5100${url}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            return response.json();
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(elementId, message = 'åŠ è½½ä¸­...') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result loading';
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            showLoading('auth-result', 'æ­£åœ¨æµ‹è¯•ç™»å½•...');
            try {
                const result = await apiCall('/api/auth/login/', {
                    method: 'POST',
                    body: JSON.stringify({
                        login_type: 'username_password',
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                if (result.code === 0) {
                    authToken = result.data.access_token;
                    showResult('auth-result', {
                        status: 'ç™»å½•æˆåŠŸï¼',
                        user: result.data.user.username,
                        token: authToken ? 'å·²è·å–' : 'æœªè·å–'
                    });
                } else {
                    showResult('auth-result', result, true);
                }
            } catch (error) {
                showResult('auth-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•ç™»å‡º
        async function testLogout() {
            showLoading('auth-result', 'æ­£åœ¨æµ‹è¯•ç™»å‡º...');
            try {
                const result = await apiCall('/api/auth/logout/', {
                    method: 'POST'
                });
                authToken = null;
                showResult('auth-result', { status: 'ç™»å‡ºæˆåŠŸï¼', result });
            } catch (error) {
                showResult('auth-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨
        async function testGetUsers() {
            showLoading('user-result', 'æ­£åœ¨è·å–ç”¨æˆ·åˆ—è¡¨...');
            try {
                const result = await apiCall('/api/users/');
                showResult('user-result', {
                    status: 'è·å–æˆåŠŸï¼',
                    count: result.count || result.length,
                    sample: result.results ? result.results.slice(0, 3) : result.slice(0, 3)
                });
            } catch (error) {
                showResult('user-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•è·å–éƒ¨é—¨åˆ—è¡¨
        async function testGetDepartments() {
            showLoading('user-result', 'æ­£åœ¨è·å–éƒ¨é—¨åˆ—è¡¨...');
            try {
                const result = await apiCall('/api/departments/');
                showResult('user-result', {
                    status: 'è·å–æˆåŠŸï¼',
                    count: result.length || result.count,
                    departments: Array.isArray(result) ? result.slice(0, 5) : result.results?.slice(0, 5)
                });
            } catch (error) {
                showResult('user-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•è·å–ç»è¥åŒºåŸŸ
        async function testGetRegions() {
            showLoading('business-result', 'æ­£åœ¨è·å–ç»è¥åŒºåŸŸ...');
            try {
                const result = await apiCall('/api/base-data/regions/');
                showResult('business-result', {
                    status: 'è·å–æˆåŠŸï¼',
                    count: result.count || result.length,
                    regions: result.results || result
                });
            } catch (error) {
                showResult('business-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•è·å–å¼€åº—è®¡åˆ’
        async function testGetPlans() {
            showLoading('business-result', 'æ­£åœ¨è·å–å¼€åº—è®¡åˆ’...');
            try {
                const result = await apiCall('/api/store-planning/plans/');
                showResult('business-result', {
                    status: 'è·å–æˆåŠŸï¼',
                    count: result.count || 0,
                    plans: result.results || []
                });
            } catch (error) {
                showResult('business-result', { error: error.message }, true);
            }
        }

        // æµ‹è¯•è·å–å€™é€‰ç‚¹ä½
        async function testGetLocations() {
            showLoading('business-result', 'æ­£åœ¨è·å–å€™é€‰ç‚¹ä½...');
            try {
                const result = await apiCall('/api/expansion/locations/');
                showResult('business-result', {
                    status: 'è·å–æˆåŠŸï¼',
                    count: result.count || 0,
                    locations: result.results || []
                });
            } catch (error) {
                showResult('business-result', { error: error.message }, true);
            }
        }

        // ç³»ç»Ÿå¥åº·æ£€æŸ¥
        async function testSystemHealth() {
            showLoading('system-result', 'æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            try {
                const tests = [
                    { name: 'åç«¯è¿æ¥', test: () => apiCall('/api/users/') },
                    { name: 'è®¤è¯æœåŠ¡', test: () => apiCall('/api/auth/login/', {
                        method: 'POST',
                        body: JSON.stringify({
                            login_type: 'username_password',
                            username: 'admin',
                            password: 'admin123'
                        })
                    })},
                    { name: 'åŸºç¡€æ•°æ®', test: () => apiCall('/api/base-data/regions/') }
                ];

                const results = [];
                for (const { name, test } of tests) {
                    try {
                        await test();
                        results.push({ service: name, status: 'âœ… æ­£å¸¸' });
                    } catch (error) {
                        results.push({ service: name, status: 'âŒ å¼‚å¸¸', error: error.message });
                    }
                }

                showResult('system-result', {
                    timestamp: new Date().toLocaleString(),
                    results
                });
            } catch (error) {
                showResult('system-result', { error: error.message }, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            setTimeout(() => {
                testSystemHealth();
            }, 1000);
        };
    </script>
</body>
</html>