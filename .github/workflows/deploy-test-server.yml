name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging

permissions:
  contents: read

concurrency:
  group: test-server-deploy
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'

jobs:
  deploy:
    name: ğŸ—ï¸ æ„å»ºå¹¶éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'test' }}
    
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯é¡¹ç›®
        working-directory: frontend
        run: pnpm build
        env:
          NODE_ENV: production
          # æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒå˜é‡ - è®¾ç½®æ­£ç¡®çš„baseè·¯å¾„
          VITE_BASE_URL: /
          VITE_API_URL: ${{ vars.API_URL || 'http://192.3.11.106:9000/api' }}
          VITE_APP_ENV: test
          # å…³é”®ï¼šä¸ºæµ‹è¯•æœåŠ¡å™¨è®¾ç½®æ­£ç¡®çš„baseè·¯å¾„
          VITE_BASE: /

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd frontend/dist
          tar -czf ../../deploy-package.tar.gz .
          cd ../..
          echo "âœ… éƒ¨ç½²åŒ…å·²åˆ›å»º: deploy-package.tar.gz"
          ls -lah deploy-package.tar.gz

      - name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨..."
            
            # è®¾ç½®å˜é‡
            DEPLOY_PATH="${{ vars.DEPLOY_PATH || '/var/www/mendian-test' }}"
            BACKUP_PATH="${{ vars.BACKUP_PATH || '/var/backups/mendian' }}"
            
            # åˆ›å»ºå¿…è¦ç›®å½•
            mkdir -p $DEPLOY_PATH
            mkdir -p $BACKUP_PATH
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
              tar -czf $BACKUP_PATH/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_PATH .
              echo "âœ… å¤‡ä»½å®Œæˆ"
            fi
            
            # æ¸…ç†éƒ¨ç½²ç›®å½•
            rm -rf $DEPLOY_PATH/*
            echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæ–‡ä»¶
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp/"

      - name: ğŸ”§ è§£å‹å¹¶é…ç½®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸ”§ è§£å‹å’Œé…ç½®..."
            
            DEPLOY_PATH="${{ vars.DEPLOY_PATH || '/var/www/mendian-test' }}"
            
            # è§£å‹éƒ¨ç½²æ–‡ä»¶
            cd /tmp
            tar -xzf deploy-package.tar.gz -C $DEPLOY_PATH
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            chmod -R 755 $DEPLOY_PATH
            
            # æ£€æµ‹Linuxå‘è¡Œç‰ˆ
            if command -v apt-get >/dev/null 2>&1; then
                DISTRO="debian"
                PACKAGE_MANAGER="apt-get"
            elif command -v yum >/dev/null 2>&1; then
                DISTRO="centos"
                PACKAGE_MANAGER="yum"
            elif command -v dnf >/dev/null 2>&1; then
                DISTRO="centos"
                PACKAGE_MANAGER="dnf"
            else
                echo "âš ï¸ æ— æ³•æ£€æµ‹Linuxå‘è¡Œç‰ˆï¼Œå‡è®¾ä¸ºé€šç”¨ç³»ç»Ÿ"
                DISTRO="generic"
            fi
            
            echo "ğŸ“‹ æ£€æµ‹åˆ°ç³»ç»Ÿç±»å‹: $DISTRO"
            
            # æ£€æŸ¥å¹¶å®‰è£…nginx
            if ! command -v nginx >/dev/null 2>&1; then
                echo "ğŸ“¦ nginxæœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
                case $DISTRO in
                    "debian")
                        sudo $PACKAGE_MANAGER update -y
                        sudo $PACKAGE_MANAGER install -y nginx
                        ;;
                    "centos")
                        sudo $PACKAGE_MANAGER install -y epel-release
                        sudo $PACKAGE_MANAGER install -y nginx
                        ;;
                    *)
                        echo "âŒ æ— æ³•è‡ªåŠ¨å®‰è£…nginxï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
                        exit 1
                        ;;
                esac
            fi
            
            # ç¡®ä¿nginxæœåŠ¡å·²å¯åŠ¨
            sudo systemctl enable nginx || sudo chkconfig nginx on
            sudo systemctl start nginx || sudo service nginx start
            
            # åˆ›å»ºnginxé…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            sudo mkdir -p /etc/nginx/conf.d
            sudo mkdir -p /etc/nginx/sites-available
            sudo mkdir -p /etc/nginx/sites-enabled
            
            # æ£€æŸ¥nginxä¸»é…ç½®æ–‡ä»¶æ˜¯å¦åŒ…å«sites-enabled
            NGINX_CONF="/etc/nginx/nginx.conf"
            if ! grep -q "sites-enabled" "$NGINX_CONF" 2>/dev/null; then
                echo "ğŸ”§ æ›´æ–°nginxä¸»é…ç½®ä»¥åŒ…å«sites-enabledç›®å½•..."
                # åœ¨httpå—ä¸­æ·»åŠ includeè¯­å¥
                sudo sed -i '/http {/a\\tinclude /etc/nginx/sites-enabled/*;' "$NGINX_CONF" || {
                    echo "âš ï¸ æ— æ³•è‡ªåŠ¨æ›´æ–°nginx.confï¼Œå°†ä½¿ç”¨conf.dç›®å½•"
                    USE_CONF_D=true
                }
            fi
            
            # åˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶
            if [ "$USE_CONF_D" = true ]; then
                SITE_CONFIG="/etc/nginx/conf.d/mendian-test.conf"
            else
                SITE_CONFIG="/etc/nginx/sites-available/mendian-test"
            fi
            
            echo "ğŸ”§ åˆ›å»ºnginxé…ç½®æ–‡ä»¶: $SITE_CONFIG"
            sudo tee "$SITE_CONFIG" > /dev/null <<EOF
            server {
                listen 9000;
                server_name 192.3.11.106 localhost _;
                root $DEPLOY_PATH;
                index index.html index.htm;
                
                # æ—¥å¿—æ–‡ä»¶
                access_log /var/log/nginx/mendian-test-access.log;
                error_log /var/log/nginx/mendian-test-error.log;
                
                # SPA è·¯ç”±æ”¯æŒ
                location / {
                    try_files \$uri \$uri/ /index.html;
                    # æ·»åŠ CORSå¤´ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    add_header Access-Control-Allow-Origin *;
                    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
                    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
                }
                
                # é™æ€èµ„æºç¼“å­˜
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    access_log off;
                }
                
                # APIä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
                location /api/ {
                    proxy_pass http://localhost:7900/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
                
                # å®‰å…¨é…ç½®
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                add_header Referrer-Policy "strict-origin-when-cross-origin" always;
                
                # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
                location ~ /\. {
                    deny all;
                }
                
                # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
                location ~ ~$ {
                    deny all;
                }
            }
            EOF
            
            # å¯ç”¨ç«™ç‚¹ï¼ˆä»…åœ¨ä½¿ç”¨sites-enabledæ—¶ï¼‰
            if [ "$USE_CONF_D" != true ] && [ -d "/etc/nginx/sites-enabled" ]; then
                echo "ğŸ”— å¯ç”¨ç«™ç‚¹é…ç½®..."
                sudo ln -sf "$SITE_CONFIG" /etc/nginx/sites-enabled/mendian-test
                
                # ç§»é™¤é»˜è®¤ç«™ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ä¸”ç›‘å¬80ç«¯å£ï¼‰
                if [ -f "/etc/nginx/sites-enabled/default" ]; then
                    sudo rm -f /etc/nginx/sites-enabled/default
                fi
            fi
            
            # åˆ›å»ºæ—¥å¿—ç›®å½•
            sudo mkdir -p /var/log/nginx
            sudo chmod 755 /var/log/nginx
            
            # æµ‹è¯•nginxé…ç½®
            echo "ğŸ§ª æµ‹è¯•nginxé…ç½®..."
            if sudo nginx -t; then
                echo "âœ… nginxé…ç½®æµ‹è¯•é€šè¿‡"
                # é‡æ–°åŠ è½½nginx
                if sudo systemctl reload nginx; then
                    echo "âœ… nginxé‡æ–°åŠ è½½æˆåŠŸ"
                elif sudo service nginx reload; then
                    echo "âœ… nginxé‡æ–°åŠ è½½æˆåŠŸ (ä½¿ç”¨serviceå‘½ä»¤)"
                else
                    echo "âš ï¸ nginxé‡æ–°åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡å¯..."
                    if sudo systemctl restart nginx; then
                        echo "âœ… nginxé‡å¯æˆåŠŸ"
                    elif sudo service nginx restart; then
                        echo "âœ… nginxé‡å¯æˆåŠŸ (ä½¿ç”¨serviceå‘½ä»¤)"
                    else
                        echo "âŒ nginxé‡å¯å¤±è´¥"
                        exit 1
                    fi
                fi
            else
                echo "âŒ nginxé…ç½®æµ‹è¯•å¤±è´¥"
                echo "ğŸ“‹ nginxé…ç½®æ–‡ä»¶å†…å®¹:"
                sudo cat "$SITE_CONFIG"
                exit 1
            fi
            
            # æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥ç«¯å£9000ç›‘å¬çŠ¶æ€..."
            if sudo netstat -tlnp | grep :9000 || sudo ss -tlnp | grep :9000; then
                echo "âœ… ç«¯å£9000å·²æ­£åœ¨ç›‘å¬"
            else
                echo "âš ï¸ ç«¯å£9000æœªåœ¨ç›‘å¬ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜"
            fi
            
            # æ˜¾ç¤ºnginxè¿›ç¨‹çŠ¶æ€
            echo "ğŸ“Š nginxè¿›ç¨‹çŠ¶æ€:"
            sudo systemctl status nginx --no-pager -l || sudo service nginx status
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/deploy-package.tar.gz
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ ç½‘ç«™åœ°å€: http://192.3.11.106:9000"
            echo "ğŸ“‹ nginxé…ç½®æ–‡ä»¶: $SITE_CONFIG"
            echo "ğŸ“ è®¿é—®æ—¥å¿—: /var/log/nginx/mendian-test-access.log"
            echo "ğŸ“ é”™è¯¯æ—¥å¿—: /var/log/nginx/mendian-test-error.log"

      - name: ğŸ§ª éƒ¨ç½²åå¥åº·æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸ§ª æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            SITE_URL="http://192.3.11.106:9000"
            DEPLOY_PATH="${{ vars.DEPLOY_PATH || '/var/www/mendian-test' }}"
            
            # æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶..."
            if [ -f "$DEPLOY_PATH/index.html" ]; then
                echo "âœ… index.htmlæ–‡ä»¶å­˜åœ¨"
                echo "ğŸ“‹ æ–‡ä»¶å¤§å°: $(ls -lh $DEPLOY_PATH/index.html | awk '{print $5}')"
            else
                echo "âŒ index.htmlæ–‡ä»¶ä¸å­˜åœ¨"
                echo "ğŸ“‹ éƒ¨ç½²ç›®å½•å†…å®¹:"
                ls -la "$DEPLOY_PATH" || echo "éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # æ£€æŸ¥nginxé…ç½®å’ŒçŠ¶æ€
            echo "ğŸ”§ æ£€æŸ¥nginxçŠ¶æ€..."
            if sudo systemctl is-active nginx >/dev/null 2>&1; then
                echo "âœ… nginxæœåŠ¡è¿è¡Œä¸­"
            elif sudo service nginx status >/dev/null 2>&1; then
                echo "âœ… nginxæœåŠ¡è¿è¡Œä¸­ (serviceå‘½ä»¤æ£€æµ‹)"
            else
                echo "âŒ nginxæœåŠ¡æœªè¿è¡Œ"
                echo "ğŸ“‹ nginxçŠ¶æ€:"
                sudo systemctl status nginx --no-pager -l || sudo service nginx status
            fi
            
            # æ£€æŸ¥ç«¯å£ç›‘å¬
            echo "ğŸ” æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€..."
            PORT_CHECK=$(sudo netstat -tlnp 2>/dev/null | grep :9000 || sudo ss -tlnp 2>/dev/null | grep :9000 || echo "")
            if [ -n "$PORT_CHECK" ]; then
                echo "âœ… ç«¯å£9000æ­£åœ¨ç›‘å¬:"
                echo "$PORT_CHECK"
            else
                echo "âŒ ç«¯å£9000æœªåœ¨ç›‘å¬"
                echo "ğŸ“‹ æ‰€æœ‰ç›‘å¬ç«¯å£:"
                sudo netstat -tlnp 2>/dev/null || sudo ss -tlnp 2>/dev/null || echo "æ— æ³•è·å–ç«¯å£ä¿¡æ¯"
            fi
            
            # æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—
            echo "ğŸ“ æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—..."
            if [ -f "/var/log/nginx/mendian-test-error.log" ]; then
                ERROR_COUNT=$(wc -l < /var/log/nginx/mendian-test-error.log)
                if [ "$ERROR_COUNT" -gt 0 ]; then
                    echo "âš ï¸ å‘ç° $ERROR_COUNT è¡Œé”™è¯¯æ—¥å¿—:"
                    sudo tail -10 /var/log/nginx/mendian-test-error.log
                else
                    echo "âœ… æš‚æ— é”™è¯¯æ—¥å¿—"
                fi
            else
                echo "âš ï¸ é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            
            # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ (10ç§’)..."
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ©º å¼€å§‹HTTPå¥åº·æ£€æŸ¥..."
            for i in {1..5}; do
              echo "ğŸ“¡ å°è¯•è¿æ¥ $SITE_URL (ç¬¬ $i/5 æ¬¡)..."
              
              # ä½¿ç”¨curlè¿›è¡Œè¯¦ç»†çš„å¥åº·æ£€æŸ¥
              HTTP_STATUS=$(curl -o /tmp/health_check_output.html -w "%{http_code}" -s --max-time 30 "$SITE_URL" 2>/tmp/curl_error.log)
              CURL_EXIT=$?
              
              if [ $CURL_EXIT -eq 0 ] && [ "$HTTP_STATUS" = "200" ]; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (HTTPçŠ¶æ€ç : $HTTP_STATUS)"
                
                # æ£€æŸ¥è¿”å›å†…å®¹
                if [ -f "/tmp/health_check_output.html" ]; then
                  CONTENT_SIZE=$(wc -c < /tmp/health_check_output.html)
                  echo "ğŸ“„ å“åº”å†…å®¹å¤§å°: $CONTENT_SIZE å­—èŠ‚"
                  
                  if [ "$CONTENT_SIZE" -gt 100 ]; then
                    echo "âœ… å“åº”å†…å®¹æ­£å¸¸"
                    echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™æ­£å¸¸è¿è¡Œ"
                    
                    # æ˜¾ç¤ºå‰å‡ è¡Œå†…å®¹ç¡®è®¤
                    echo "ğŸ“‹ å“åº”å†…å®¹é¢„è§ˆ:"
                    head -5 /tmp/health_check_output.html
                    
                    rm -f /tmp/health_check_output.html /tmp/curl_error.log
                    break
                  else
                    echo "âš ï¸ å“åº”å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜"
                  fi
                fi
              else
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ (HTTPçŠ¶æ€ç : ${HTTP_STATUS:-'æ— '}, curlé€€å‡ºç : $CURL_EXIT)"
                
                if [ -f "/tmp/curl_error.log" ]; then
                  echo "ğŸ“‹ curlé”™è¯¯ä¿¡æ¯:"
                  cat /tmp/curl_error.log
                fi
                
                if [ $i -eq 5 ]; then
                  echo "âš ï¸ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œè¿›è¡Œæ•…éšœæ’æŸ¥..."
                  
                  # è¯¦ç»†çš„æ•…éšœæ’æŸ¥ä¿¡æ¯
                  echo "ğŸ” æ•…éšœæ’æŸ¥ä¿¡æ¯:"
                  echo "1. Nginxé…ç½®æµ‹è¯•:"
                  sudo nginx -t
                  
                  echo "2. Nginxè¿›ç¨‹çŠ¶æ€:"
                  ps aux | grep nginx || echo "æœªæ‰¾åˆ°nginxè¿›ç¨‹"
                  
                  echo "3. ç³»ç»Ÿç«¯å£å ç”¨:"
                  sudo netstat -tlnp | grep :9000 || echo "ç«¯å£9000æœªè¢«å ç”¨"
                  
                  echo "4. é˜²ç«å¢™çŠ¶æ€ (å¦‚æœé€‚ç”¨):"
                  sudo iptables -L -n | grep 9000 || echo "æœªå‘ç°é˜²ç«å¢™è§„åˆ™"
                  
                  echo "5. SELinuxçŠ¶æ€ (å¦‚æœé€‚ç”¨):"
                  sestatus 2>/dev/null || echo "SELinuxæœªå¯ç”¨æˆ–ä¸å¯ç”¨"
                  
                  echo "ğŸ’¡ è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯æ‰‹åŠ¨æ£€æŸ¥ï¼Œæˆ–è®¿é—® $SITE_URL ç¡®è®¤éƒ¨ç½²çŠ¶æ€"
                  echo "ğŸ’¡ ä¹Ÿå¯ä»¥æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—: /var/log/nginx/mendian-test-error.log"
                else
                  echo "â³ ç­‰å¾…10ç§’åé‡è¯•..."
                  sleep 10
                fi
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f /tmp/health_check_output.html /tmp/curl_error.log
            done

      - name: ğŸ“± å‘é€é€šçŸ¥ (å¯é€‰)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            STATUS="${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
            echo "ğŸ“± éƒ¨ç½²çŠ¶æ€: $STATUS"
            echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date)"
            echo "ğŸ“ æäº¤: ${{ github.sha }}"
            echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
            echo "ğŸŒ ç½‘ç«™: http://192.3.11.106:9000"

      - name: ğŸ“‹ éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && 'âœ… éƒ¨ç½²æˆåŠŸ' || 'âŒ éƒ¨ç½²å¤±è´¥' }}"
          
          echo "## ğŸš€ æµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“Š çŠ¶æ€**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ ç½‘ç«™**: http://192.3.11.106:9000" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ¿ åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **â° éƒ¨ç½²æ—¶é—´**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”¢ æ„å»ºç¼–å·**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "æ‚¨çš„æµ‹è¯•ç¯å¢ƒå·²æˆåŠŸæ›´æ–°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
          fi