name: ðŸš€ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging

permissions:
  contents: read

concurrency:
  group: test-server-deploy
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'

jobs:
  deploy:
    name: ðŸ—ï¸ æž„å»ºå¹¶éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'test' }}
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ðŸ—ï¸ æž„å»ºå‰ç«¯é¡¹ç›®
        working-directory: frontend
        run: pnpm build
        env:
          NODE_ENV: production
          # æµ‹è¯•æœåŠ¡å™¨çŽ¯å¢ƒå˜é‡ - è¯·æ ¹æ®å®žé™…æƒ…å†µä¿®æ”¹
          VITE_BASE_URL: /
          VITE_API_URL: ${{ vars.API_URL || 'http://your-test-server.com/api' }}
          VITE_APP_ENV: test

      - name: ðŸ“¦ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ðŸ“¦ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          # åˆ›å»ºéƒ¨ç½²åŒ…
          cd frontend/dist
          tar -czf ../../deploy-package.tar.gz .
          cd ../..
          echo "âœ… éƒ¨ç½²åŒ…å·²åˆ›å»º: deploy-package.tar.gz"
          ls -lah deploy-package.tar.gz

      - name: ðŸš€ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨..."
            
            # è®¾ç½®å˜é‡
            DEPLOY_PATH="${{ vars.DEPLOY_PATH || '/var/www/mendian-test' }}"
            BACKUP_PATH="${{ vars.BACKUP_PATH || '/var/backups/mendian' }}"
            
            # åˆ›å»ºå¿…è¦ç›®å½•
            mkdir -p $DEPLOY_PATH
            mkdir -p $BACKUP_PATH
            
            # å¤‡ä»½çŽ°æœ‰éƒ¨ç½²ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "ðŸ“¦ å¤‡ä»½çŽ°æœ‰éƒ¨ç½²..."
              tar -czf $BACKUP_PATH/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_PATH .
              echo "âœ… å¤‡ä»½å®Œæˆ"
            fi
            
            # æ¸…ç†éƒ¨ç½²ç›®å½•
            rm -rf $DEPLOY_PATH/*
            echo "ðŸ§¹ æ¸…ç†å®Œæˆ"

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºæ–‡ä»¶
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp/"

      - name: ðŸ”§ è§£åŽ‹å¹¶é…ç½®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ðŸ”§ è§£åŽ‹å’Œé…ç½®..."
            
            DEPLOY_PATH="${{ vars.DEPLOY_PATH || '/var/www/mendian-test' }}"
            
            # è§£åŽ‹éƒ¨ç½²æ–‡ä»¶
            cd /tmp
            tar -xzf deploy-package.tar.gz -C $DEPLOY_PATH
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            chmod -R 755 $DEPLOY_PATH
            
            # åˆ›å»º nginx é…ç½®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
            if [ ! -f "/etc/nginx/sites-available/mendian-test" ]; then
              echo "ðŸ”§ åˆ›å»º nginx é…ç½®..."
              tee /etc/nginx/sites-available/mendian-test > /dev/null <<EOF
            server {
                listen 9000;
                server_name 192.3.11.106;
                root $DEPLOY_PATH;
                index index.html;
                
                # SPA è·¯ç”±æ”¯æŒ
                location / {
                    try_files \$uri \$uri/ /index.html;
                }
                
                # é™æ€èµ„æºç¼“å­˜
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
                
                # å®‰å…¨é…ç½®
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
            }
            EOF
              
              # å¯ç”¨ç«™ç‚¹
              ln -sf /etc/nginx/sites-available/mendian-test /etc/nginx/sites-enabled/
            fi
            
            # æµ‹è¯• nginx é…ç½®
            nginx -t && systemctl reload nginx || service nginx reload
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/deploy-package.tar.gz
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ðŸŒ ç½‘ç«™åœ°å€: http://192.3.11.106:9000"

      - name: ðŸ§ª éƒ¨ç½²åŽå¥åº·æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ðŸ§ª æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            SITE_URL="http://192.3.11.106:9000"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            for i in {1..5}; do
              if curl -f -s --max-time 30 "$SITE_URL" > /dev/null; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i/5)"
                echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™æ­£å¸¸è¿è¡Œ"
                break
              else
                echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (å°è¯• $i/5)"
                if [ $i -eq 5 ]; then
                  echo "âš ï¸ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œä½†å¯èƒ½ä»éœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
                  echo "ðŸ’¡ è¯·æ‰‹åŠ¨è®¿é—® $SITE_URL ç¡®è®¤éƒ¨ç½²çŠ¶æ€"
                fi
                sleep 10
              fi
            done

      - name: ðŸ“± å‘é€é€šçŸ¥ (å¯é€‰)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          password: ${{ secrets.TEST_SERVER_PASSWORD }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            STATUS="${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
            echo "ðŸ“± éƒ¨ç½²çŠ¶æ€: $STATUS"
            echo "ðŸ• éƒ¨ç½²æ—¶é—´: $(date)"
            echo "ðŸ“ æäº¤: ${{ github.sha }}"
            echo "ðŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
            echo "ðŸŒ ç½‘ç«™: http://192.3.11.106:9000"

      - name: ðŸ“‹ éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && 'âœ… éƒ¨ç½²æˆåŠŸ' || 'âŒ éƒ¨ç½²å¤±è´¥' }}"
          
          echo "## ðŸš€ æµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“Š çŠ¶æ€**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ ç½‘ç«™**: http://192.3.11.106:9000" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ¿ åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **â° éƒ¨ç½²æ—¶é—´**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”¢ æž„å»ºç¼–å·**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "æ‚¨çš„æµ‹è¯•çŽ¯å¢ƒå·²æˆåŠŸæ›´æ–°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŽŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
          fi