name: ðŸ“– éƒ¨ç½²åˆ° GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'pnpm-lock.yaml'
      - 'yarn.lock'
      - 'vite.config.*'
      - 'tsconfig.*'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²'
        required: false
        default: false
        type: boolean

# è®¾ç½® GitHub Pages æ‰€éœ€çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æŽ§åˆ¶ - ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: pages
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  # æž„å»ºä¼˜åŒ–
  CI: 'true'
  NODE_OPTIONS: '--max-old-space-size=4096'
  FORCE_COLOR: '1'

jobs:
  # çŽ¯å¢ƒæ£€æµ‹
  setup:
    name: ðŸ” çŽ¯å¢ƒæ£€æµ‹
    runs-on: ubuntu-latest
    outputs:
      package-manager: ${{ steps.detect-pm.outputs.package-manager }}
      project-structure: ${{ steps.detect-structure.outputs.project-structure }}
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” æ£€æµ‹é¡¹ç›®ç»“æž„
        id: detect-structure
        run: |
          if [ -d "frontend" ]; then
            echo "project-structure=workspace" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å·¥ä½œåŒºç»“æž„ (frontend ç›®å½•)"
          else
            echo "project-structure=single" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å•é¡¹ç›®ç»“æž„ (æ ¹ç›®å½•)"
          fi

      - name: ðŸ“¦ æ£€æµ‹åŒ…ç®¡ç†å™¨
        id: detect-pm
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "package-manager=pnpm" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ ä½¿ç”¨ pnpm"
          elif [ -f "yarn.lock" ]; then
            echo "package-manager=yarn" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ ä½¿ç”¨ yarn"
          else
            echo "package-manager=npm" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ ä½¿ç”¨ npm"
          fi

  # æž„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: ðŸ—ï¸ æž„å»ºå¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: setup
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ è®¾ç½®åŒ…ç®¡ç†å™¨ (pnpm)
        if: needs.setup.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.setup.outputs.package-manager }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          echo "ðŸ”§ ä½¿ç”¨ ${{ needs.setup.outputs.package-manager }} å®‰è£…ä¾èµ–..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              # pnpmå·¥ä½œåŒºé¡¹ç›®ï¼Œä½¿ç”¨æ›´å®½æ¾çš„å®‰è£…ç­–ç•¥
              pnpm install --no-frozen-lockfile || pnpm install
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            *)
              npm ci
              ;;
          esac

      - name: ðŸ”§ ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          echo "â­ï¸  è·³è¿‡TypeScriptå’ŒESLintæ£€æŸ¥ä»¥åŠ é€Ÿéƒ¨ç½²"
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å·²è·³è¿‡ï¼ˆä¸“æ³¨äºŽå¿«é€Ÿéƒ¨ç½²ï¼‰"
        continue-on-error: true

      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          echo "ðŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm --filter "@mendian/frontend" test 2>/dev/null || pnpm --filter "frontend" test 2>/dev/null || pnpm test 2>/dev/null || echo "âœ… æµ‹è¯•å®Œæˆ"
              else
                pnpm test 2>/dev/null || echo "âœ… æµ‹è¯•å®Œæˆ"
              fi
              ;;
            "yarn")
              yarn test 2>/dev/null || echo "âœ… æµ‹è¯•å®Œæˆ"
              ;;
            *)
              npm run test 2>/dev/null || echo "âœ… æµ‹è¯•å®Œæˆ"
              ;;
          esac
        env:
          NODE_ENV: test
          CI: true
        continue-on-error: true

      - name: ðŸ—ï¸ æž„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          echo "ðŸ—ï¸ æž„å»ºç”Ÿäº§ç‰ˆæœ¬..."
          
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                # pnpmå·¥ä½œåŒºï¼šä»…æž„å»ºå‰ç«¯é¡¹ç›®ï¼ˆè·³è¿‡TypeScriptæ£€æŸ¥ï¼‰
                echo "ðŸ“¦ æž„å»ºå‰ç«¯é¡¹ç›®ï¼ˆè·³è¿‡TypeScriptæ£€æŸ¥ï¼‰..."
                pnpm --filter "@mendian/frontend" build || pnpm --filter "frontend" build
              else
                # å•é¡¹ç›®æž„å»ºï¼ˆè·³è¿‡TypeScriptæ£€æŸ¥ï¼‰
                echo "ðŸ“¦ ç›´æŽ¥ä½¿ç”¨vite build..."
                pnpm build
              fi
              ;;
            "yarn")
              yarn build
              ;;
            *)
              npm run build
              ;;
          esac
        env:
          NODE_ENV: production
          # GitHub Pages ç›¸å…³çŽ¯å¢ƒå˜é‡
          PUBLIC_URL: /mendian
          VITE_BASE_URL: /mendian/
          VITE_APP_BASE_URL: /mendian/
          REACT_APP_BASE_URL: /mendian/
          BASE_URL: /mendian/
          # åº”ç”¨å…ƒä¿¡æ¯
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_APP_BUILD_DATE: ${{ github.event.head_commit.timestamp }}
          VITE_APP_ENVIRONMENT: production
          VITE_APP_COMMIT_SHA: ${{ github.sha }}
          VITE_APP_BRANCH: ${{ github.ref_name }}
          REACT_APP_VERSION: ${{ github.sha }}
          REACT_APP_ENVIRONMENT: production

      - name: ðŸ“Š æž„å»ºåˆ†æž
        run: |
          echo "ðŸ“Š åˆ†æžæž„å»ºç»“æžœ..."
          
          # ç¡®å®šæž„å»ºè¾“å‡ºç›®å½•
          BUILD_DIR=""
          if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ] && [ -d "frontend/dist" ]; then
            BUILD_DIR="frontend/dist"
          elif [ -d "dist" ]; then
            BUILD_DIR="dist"
          elif [ -d "build" ]; then
            BUILD_DIR="build"
          else
            echo "âŒ æž„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ°æž„å»ºè¾“å‡ºç›®å½•"
            find . -name "dist" -o -name "build" -type d
            exit 1
          fi
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "âœ… æž„å»ºè¾“å‡ºç›®å½•: $BUILD_DIR"
          echo "ðŸ“¦ æž„å»ºå¤§å°: $(du -sh $BUILD_DIR | cut -f1)"
          echo "ðŸ“„ æ–‡ä»¶æ•°é‡: $(find $BUILD_DIR -type f | wc -l)"
          echo "ðŸ—‚ï¸ ä¸»è¦æ–‡ä»¶:"
          ls -lah $BUILD_DIR/ | head -10

      - name: ðŸ”§ ä¼˜åŒ– GitHub Pages éƒ¨ç½²
        run: |
          echo "ðŸ”§ ä¸º GitHub Pages ä¼˜åŒ–æž„å»ºäº§ç‰©..."
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ä»¥ç¦ç”¨ Jekyll å¤„ç†
          touch $BUILD_DIR/.nojekyll
          echo "âœ… å·²åˆ›å»º .nojekyll æ–‡ä»¶"
          
          # åˆ›å»º 404.htmlï¼ˆç”¨äºŽ SPA è·¯ç”±ï¼‰
          if [ ! -f "$BUILD_DIR/404.html" ]; then
            if [ -f "$BUILD_DIR/index.html" ]; then
              cp "$BUILD_DIR/index.html" "$BUILD_DIR/404.html"
              echo "âœ… å·²åˆ›å»º 404.htmlï¼ˆSPA è·¯ç”±æ”¯æŒï¼‰"
            fi
          fi
          
          # åˆ›å»º CNAME æ–‡ä»¶ï¼ˆå¦‚æžœæœ‰è‡ªå®šä¹‰åŸŸåï¼‰
          # echo "yourdomain.com" > $BUILD_DIR/CNAME
          
          # éªŒè¯é‡è¦æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$BUILD_DIR/index.html" ]; then
            echo "âŒ é”™è¯¯ï¼šindex.html æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… GitHub Pages ä¼˜åŒ–å®Œæˆ"

      - name: ðŸ”’ å®‰å…¨æ£€æŸ¥
        run: |
          echo "ðŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
          echo "ðŸ” æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."
          SENSITIVE_FILES=$(find $BUILD_DIR -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "config.json" | wc -l)
          
          if [ $SENSITIVE_FILES -gt 0 ]; then
            echo "âš ï¸ å‘çŽ°å¯èƒ½çš„æ•æ„Ÿæ–‡ä»¶ï¼š"
            find $BUILD_DIR -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "config.json"
            echo "âŒ è¯·æ£€æŸ¥è¿™äº›æ–‡ä»¶æ˜¯å¦åº”è¯¥è¢«å‘å¸ƒ"
            # exit 1  # å–æ¶ˆæ³¨é‡Šä»¥åœ¨å‘çŽ°æ•æ„Ÿæ–‡ä»¶æ—¶ç»ˆæ­¢éƒ¨ç½²
          else
            echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          LARGE_FILES=$(find $BUILD_DIR -size +10M -type f)
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ å‘çŽ°å¤§æ–‡ä»¶ (>10MB)ï¼š"
            echo "$LARGE_FILES" | xargs ls -lh
            echo "ðŸ’¡ å»ºè®®ï¼šè€ƒè™‘åŽ‹ç¼©æˆ–ç§»é™¤å¤§æ–‡ä»¶ä»¥æé«˜åŠ è½½é€Ÿåº¦"
          fi

      - name: ðŸ“‹ ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ðŸ“‹ ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶..."
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          cat > $BUILD_DIR/deploy-info.json << EOF
          {
            "deployTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "gitCommit": "${{ github.sha }}",
            "gitBranch": "${{ github.ref_name }}",
            "buildNumber": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "environment": "production",
            "platform": "GitHub Pages"
          }
          EOF
          
          echo "âœ… éƒ¨ç½²ä¿¡æ¯æ–‡ä»¶å·²åˆ›å»º"
          cat $BUILD_DIR/deploy-info.json

      - name: ðŸ“¤ è®¾ç½® GitHub Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¦ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_DIR }}

      - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸ§ª éƒ¨ç½²åŽéªŒè¯
        run: |
          echo "ðŸ§ª éƒ¨ç½²åŽéªŒè¯..."
          
          SITE_URL="${{ steps.deployment.outputs.page_url }}"
          echo "ðŸŒ éƒ¨ç½² URL: $SITE_URL"
          
          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          echo "â³ ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..5}; do
            if curl -f -s --max-time 30 "$SITE_URL" > /dev/null; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i/5)"
              break
            else
              echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (å°è¯• $i/5)"
              if [ $i -eq 5 ]; then
                echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
                echo "ðŸ’¡ è¯·æ‰‹åŠ¨è®¿é—® $SITE_URL ç¡®è®¤éƒ¨ç½²çŠ¶æ€"
              fi
              sleep 10
            fi
          done

      - name: ðŸ“ éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && 'âœ… éƒ¨ç½²æˆåŠŸ' || 'âŒ éƒ¨ç½²å¤±è´¥' }}"
          SITE_URL="${{ steps.deployment.outputs.page_url }}"
          
          echo "## ðŸ“– GitHub Pages éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ ç½‘ç«™ URL**: [$SITE_URL]($SITE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ¿ åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **â° éƒ¨ç½²æ—¶é—´**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“Š çŠ¶æ€**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”¢ æž„å»ºç¼–å·**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‚¨çš„å¥½é¥­ç¢—é—¨åº—ç®¡ç†ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pagesï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸŒ è®¿é—® [$SITE_URL]($SITE_URL) æŸ¥çœ‹æ‚¨çš„åº”ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ” æµ‹è¯•æ‰€æœ‰ä¸»è¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ“± éªŒè¯ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡" >> $GITHUB_STEP_SUMMARY
            echo "4. âš™ï¸ å¦‚éœ€è‡ªå®šä¹‰åŸŸåï¼Œè¯·åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— æœ‰ç”¨çš„é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“– [GitHub Pages è®¾ç½®](https://github.com/${{ github.repository }}/settings/pages)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ [è‡ªå®šä¹‰åŸŸåé…ç½®](https://docs.github.com/pages/configuring-a-custom-domain-for-your-github-pages-site)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š [éƒ¨ç½²åŽ†å²](https://github.com/${{ github.repository }}/deployments)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŽŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ å¸¸è§é—®é¢˜æŽ’æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "1. æ£€æŸ¥æž„å»ºå‘½ä»¤æ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "2. éªŒè¯çŽ¯å¢ƒå˜é‡è®¾ç½®" >> $GITHUB_STEP_SUMMARY
            echo "3. ç¡®è®¤ä¾èµ–å®‰è£…æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "4. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi