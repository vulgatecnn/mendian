name: ðŸŽ¨ Frontend CI/CD Pipeline

on:
  push:
    branches: [ main, develop, master, 'feature/*', 'hotfix/*' ]
    paths:
      - 'frontend/**'
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'pnpm-lock.yaml'
      - 'yarn.lock'
      - '.github/workflows/**'
      - 'vite.config.*'
      - 'tsconfig.*'
  pull_request:
    branches: [ main, develop, master ]
    paths:
      - 'frontend/**'
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'pnpm-lock.yaml'
      - 'yarn.lock'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: false
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: read
  packages: write
  deployments: write
  pull-requests: write
  checks: write

# å¹¶å‘æŽ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  # æ£€æµ‹åŒ…ç®¡ç†å™¨ç±»åž‹
  CI: 'true'
  NODE_OPTIONS: '--max-old-space-size=4096'
  FORCE_COLOR: '1'

jobs:
  # çŽ¯å¢ƒæ£€æµ‹å’Œé¢„æ£€æŸ¥
  setup:
    name: ðŸ” çŽ¯å¢ƒæ£€æµ‹ä¸Žé¢„æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      package-manager: ${{ steps.detect-pm.outputs.package-manager }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
      project-structure: ${{ steps.detect-structure.outputs.project-structure }}
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” æ£€æµ‹é¡¹ç›®ç»“æž„
        id: detect-structure
        run: |
          if [ -d "frontend" ]; then
            echo "project-structure=workspace" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å·¥ä½œåŒºç»“æž„ (frontendç›®å½•å­˜åœ¨)"
          elif [ -d "src" ] && [ -f "package.json" ]; then
            echo "project-structure=single" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å•é¡¹ç›®ç»“æž„ (æ ¹ç›®å½•æœ‰srcå’Œpackage.json)"
          else
            echo "project-structure=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªçŸ¥é¡¹ç›®ç»“æž„ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: ðŸ“¦ æ£€æµ‹åŒ…ç®¡ç†å™¨
        id: detect-pm
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "package-manager=pnpm" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ° pnpm"
          elif [ -f "yarn.lock" ]; then
            echo "package-manager=yarn" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ° yarn"
          elif [ -f "package-lock.json" ]; then
            echo "package-manager=npm" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ° npm"
          else
            echo "package-manager=npm" >> $GITHUB_OUTPUT
            echo "é»˜è®¤ä½¿ç”¨ npm"
          fi

      - name: ðŸš€ æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
        id: deploy-check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == "refs/heads/develop" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½®åŒ…ç®¡ç†å™¨
        if: needs.setup.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.setup.outputs.package-manager }}
          cache-dependency-path: |
            package-lock.json
            yarn.lock
            pnpm-lock.yaml

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm install --frozen-lockfile
              else
                pnpm install --frozen-lockfile
              fi
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            *)
              npm ci
              ;;
          esac

      - name: ðŸ”§ TypeScript ç±»åž‹æ£€æŸ¥
        run: |
          echo "è¿è¡Œ TypeScript ç±»åž‹æ£€æŸ¥..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm --filter frontend typecheck 2>/dev/null || pnpm --filter "*frontend*" typecheck 2>/dev/null || pnpm typecheck || npx tsc --noEmit
              else
                pnpm typecheck 2>/dev/null || npx tsc --noEmit
              fi
              ;;
            "yarn")
              yarn typecheck 2>/dev/null || npx tsc --noEmit
              ;;
            *)
              npm run typecheck 2>/dev/null || npx tsc --noEmit
              ;;
          esac
        continue-on-error: false

      - name: ðŸŽ¨ ESLint ä»£ç æ£€æŸ¥
        run: |
          echo "è¿è¡Œ ESLint æ£€æŸ¥..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm --filter frontend lint 2>/dev/null || pnpm --filter "*frontend*" lint 2>/dev/null || pnpm lint || npx eslint src/
              else
                pnpm lint 2>/dev/null || npx eslint src/
              fi
              ;;
            "yarn")
              yarn lint 2>/dev/null || npx eslint src/
              ;;
            *)
              npm run lint 2>/dev/null || npx eslint src/
              ;;
          esac
        continue-on-error: true

      - name: ðŸ’… Prettier æ ¼å¼æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              pnpm format:check 2>/dev/null || npx prettier --check src/ || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"
              ;;
            "yarn")
              yarn format:check 2>/dev/null || npx prettier --check src/ || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"
              ;;
            *)
              npm run format:check 2>/dev/null || npx prettier --check src/ || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"
              ;;
          esac
        continue-on-error: true

      - name: ðŸ”’ å®‰å…¨å®¡è®¡
        run: |
          echo "è¿è¡Œå®‰å…¨å®¡è®¡..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              pnpm audit --audit-level moderate || echo "å®‰å…¨å®¡è®¡å®Œæˆ"
              ;;
            "yarn")
              yarn audit --level moderate || echo "å®‰å…¨å®¡è®¡å®Œæˆ"
              ;;
            *)
              npm audit --audit-level moderate || echo "å®‰å…¨å®¡è®¡å®Œæˆ"
              ;;
          esac
        continue-on-error: true

  # æµ‹è¯•
  test:
    name: ðŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [setup, quality]
    if: inputs.skip_tests != true
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½®åŒ…ç®¡ç†å™¨
        if: needs.setup.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.setup.outputs.package-manager }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            *)
              npm ci
              ;;
          esac

      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm --filter frontend test 2>/dev/null || pnpm --filter "*frontend*" test 2>/dev/null || pnpm test || echo "æµ‹è¯•å®Œæˆ"
              else
                pnpm test 2>/dev/null || echo "æµ‹è¯•å®Œæˆ"
              fi
              ;;
            "yarn")
              yarn test 2>/dev/null || echo "æµ‹è¯•å®Œæˆ"
              ;;
            *)
              npm run test 2>/dev/null || echo "æµ‹è¯•å®Œæˆ"
              ;;
          esac
        env:
          NODE_ENV: test
          CI: true

      - name: ðŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            coverage/
            test-results/
          retention-days: 30
        continue-on-error: true

  # æž„å»º
  build:
    name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
    runs-on: ubuntu-latest
    needs: [setup, quality, test]
    if: always() && (needs.quality.result == 'success' && (needs.test.result == 'success' || inputs.skip_tests == true || needs.test.result == 'skipped'))
    
    strategy:
      matrix:
        environment: ['staging', 'production']
        exclude:
          - environment: production
            if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' && github.event.inputs.environment != 'production'
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½®åŒ…ç®¡ç†å™¨
        if: needs.setup.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.setup.outputs.package-manager }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            *)
              npm ci
              ;;
          esac

      - name: ðŸ—ï¸ æž„å»ºåº”ç”¨ (${{ matrix.environment }})
        run: |
          echo "æž„å»º ${{ matrix.environment }} çŽ¯å¢ƒ..."
          case "${{ needs.setup.outputs.package-manager }}" in
            "pnpm")
              if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ]; then
                pnpm --filter frontend build 2>/dev/null || pnpm --filter "*frontend*" build 2>/dev/null || pnpm build
              else
                pnpm build
              fi
              ;;
            "yarn")
              yarn build
              ;;
            *)
              npm run build
              ;;
          esac
        env:
          NODE_ENV: ${{ matrix.environment == 'production' && 'production' || 'staging' }}
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_APP_BUILD_DATE: ${{ github.event.head_commit.timestamp }}
          VITE_APP_ENVIRONMENT: ${{ matrix.environment }}
          VITE_APP_COMMIT_SHA: ${{ github.sha }}
          VITE_APP_BRANCH: ${{ github.ref_name }}
          # React çŽ¯å¢ƒå˜é‡
          REACT_APP_VERSION: ${{ github.sha }}
          REACT_APP_ENVIRONMENT: ${{ matrix.environment }}

      - name: ðŸ“¦ ä¼˜åŒ–æž„å»ºäº§ç‰©
        run: |
          echo "ä¼˜åŒ–æž„å»ºäº§ç‰©..."
          
          # ç¡®å®šæž„å»ºè¾“å‡ºç›®å½•
          BUILD_DIR=""
          if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ] && [ -d "frontend/dist" ]; then
            BUILD_DIR="frontend/dist"
          elif [ -d "dist" ]; then
            BUILD_DIR="dist"
          elif [ -d "build" ]; then
            BUILD_DIR="build"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æž„å»ºè¾“å‡ºç›®å½•"
            ls -la
            exit 1
          fi
          
          echo "æž„å»ºè¾“å‡ºç›®å½•: $BUILD_DIR"
          
          # ç”Ÿäº§çŽ¯å¢ƒç§»é™¤ source maps
          if [ "${{ matrix.environment }}" == "production" ]; then
            find $BUILD_DIR -name "*.map" -type f -delete 2>/dev/null || true
            echo "å·²ç§»é™¤ç”Ÿäº§çŽ¯å¢ƒçš„ source maps"
          fi
          
          # åŽ‹ç¼©é™æ€èµ„æº
          cd $BUILD_DIR
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) -exec gzip -9 -k {} \; 2>/dev/null || true
          echo "å·²åˆ›å»º gzip åŽ‹ç¼©èµ„æº"
          cd - >/dev/null

      - name: ðŸ“Š æž„å»ºåˆ†æž
        run: |
          echo "åˆ†æžæž„å»ºç»“æžœ..."
          
          BUILD_DIR=""
          if [ "${{ needs.setup.outputs.project-structure }}" == "workspace" ] && [ -d "frontend/dist" ]; then
            BUILD_DIR="frontend/dist"
          elif [ -d "dist" ]; then
            BUILD_DIR="dist"
          elif [ -d "build" ]; then
            BUILD_DIR="build"
          fi
          
          if [ -n "$BUILD_DIR" ]; then
            echo "æž„å»ºç›®å½•å¤§å°: $(du -sh $BUILD_DIR | cut -f1)"
            echo "æ–‡ä»¶æ•°é‡: $(find $BUILD_DIR -type f | wc -l)"
            echo "ä¸»è¦èµ„æºæ–‡ä»¶:"
            find $BUILD_DIR -name "*.js" -o -name "*.css" | head -10 | xargs ls -lh 2>/dev/null || true
          fi
          
          # ç”Ÿæˆæž„å»ºæŠ¥å‘Š
          echo "## ðŸ—ï¸ æž„å»ºæŠ¥å‘Š - ${{ matrix.environment }}" >> build-report.md
          echo "- **çŽ¯å¢ƒ**: ${{ matrix.environment }}" >> build-report.md
          echo "- **æž„å»ºå¤§å°**: $(du -sh $BUILD_DIR 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')" >> build-report.md
          echo "- **æ–‡ä»¶æ•°é‡**: $(find $BUILD_DIR -type f 2>/dev/null | wc -l || echo '0')" >> build-report.md
          echo "- **æäº¤**: ${{ github.sha }}" >> build-report.md
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> build-report.md
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> build-report.md

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            dist/
            build/
            frontend/dist/
            frontend/build/
            build-report.md
          retention-days: ${{ matrix.environment == 'production' && 90 || 30 }}
          compression-level: 9

  # ç®€åŒ–çš„éƒ¨ç½² (å ä½ç¬¦)
  deploy-staging:
    name: ðŸš€ éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      needs.setup.outputs.should-deploy == 'true' && 
      (github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging-mendian.yourdomain.com
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-staging-${{ github.run_number }}
          path: ./build-artifacts

      - name: ðŸŒ éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
        run: |
          echo "ðŸš€ å‡†å¤‡éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ..."
          echo "ðŸ“ æž„å»ºäº§ç‰©å·²ä¸‹è½½åˆ° ./build-artifacts"
          echo ""
          echo "ðŸ’¡ è¯·æ ¹æ®æ‚¨çš„éƒ¨ç½²å¹³å°æ·»åŠ ç›¸åº”çš„éƒ¨ç½²å‘½ä»¤:"
          echo ""
          echo "ðŸ”¸ Netlify:"
          echo "   npx netlify-cli deploy --dir=./build-artifacts/dist --site=\$NETLIFY_SITE_ID --auth=\$NETLIFY_AUTH_TOKEN"
          echo ""
          echo "ðŸ”¸ Vercel:"
          echo "   npx vercel --prebuilt --token=\$VERCEL_TOKEN"
          echo ""
          echo "ðŸ”¸ AWS S3 + CloudFront:"
          echo "   aws s3 sync ./build-artifacts/dist s3://\$AWS_S3_BUCKET/ --delete"
          echo "   aws cloudfront create-invalidation --distribution-id \$CLOUDFRONT_ID --paths '/*'"
          echo ""
          echo "ðŸ”¸ GitHub Pages:"
          echo "   é…ç½® GitHub Pages æŒ‡å‘æž„å»ºäº§ç‰©ç›®å½•"
          echo ""
          echo "ðŸ”¸ FTP/SFTP:"
          echo "   ä½¿ç”¨ rsync æˆ– FTP å·¥å…·ä¸Šä¼  ./build-artifacts/dist åˆ°æœåŠ¡å™¨"
          echo ""
          echo "âœ… æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ (å ä½ç¬¦)"

      - name: ðŸ“ éƒ¨ç½²æ‘˜è¦
        run: |
          echo "## ðŸš€ æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **çŽ¯å¢ƒ**: staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://staging-mendian.yourdomain.com" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: âœ… å·²å°±ç»ª (éœ€è¦é…ç½®å®žé™…éƒ¨ç½²å‘½ä»¤)" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: ðŸ­ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [setup, build, deploy-staging]
    if: |
      needs.setup.outputs.should-deploy == 'true' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://mendian.yourdomain.com
    
    steps:
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-production-${{ github.run_number }}
          path: ./build-artifacts

      - name: ðŸ“Š éƒ¨ç½²å‰æ£€æŸ¥
        run: |
          echo "è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
          
          if [ ! -d "./build-artifacts" ]; then
            echo "âŒ æž„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æŸ¥æ‰¾æž„å»ºç›®å½•
          BUILD_DIR=""
          for dir in "./build-artifacts/dist" "./build-artifacts/build"; do
            if [ -d "$dir" ]; then
              BUILD_DIR="$dir"
              break
            fi
          done
          
          if [ -z "$BUILD_DIR" ] || [ -z "$(ls -A $BUILD_DIR 2>/dev/null)" ]; then
            echo "âŒ æž„å»ºäº§ç‰©ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æž„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "æž„å»ºç›®å½•: $BUILD_DIR"
          echo "æ–‡ä»¶æ•°é‡: $(find $BUILD_DIR -type f | wc -l)"
          echo "æ€»å¤§å°: $(du -sh $BUILD_DIR | cut -f1)"

      - name: ðŸŒ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
        run: |
          echo "ðŸ­ å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
          echo "ðŸ“ æž„å»ºäº§ç‰©å·²éªŒè¯å¹¶å‡†å¤‡å°±ç»ª"
          echo ""
          echo "ðŸ’¡ è¯·æ ¹æ®æ‚¨çš„ç”Ÿäº§çŽ¯å¢ƒæ·»åŠ ç›¸åº”çš„éƒ¨ç½²å‘½ä»¤:"
          echo ""
          echo "ðŸ”¸ ç”Ÿäº§çº§ AWS éƒ¨ç½²:"
          echo "   # å¤‡ä»½å½“å‰ç‰ˆæœ¬"
          echo "   aws s3 sync s3://\$AWS_PROD_BUCKET/ s3://\$AWS_BACKUP_BUCKET/backup-$(date +%Y%m%d-%H%M%S)/"
          echo "   # éƒ¨ç½²æ–°ç‰ˆæœ¬"
          echo "   aws s3 sync ./build-artifacts/dist s3://\$AWS_PROD_BUCKET/ --delete"
          echo "   aws cloudfront create-invalidation --distribution-id \$PROD_CLOUDFRONT_ID --paths '/*'"
          echo ""
          echo "ðŸ”¸ Kubernetes éƒ¨ç½²:"
          echo "   kubectl apply -f k8s/production/"
          echo "   kubectl rollout status deployment/mendian-frontend -n production"
          echo ""
          echo "ðŸ”¸ Docker éƒ¨ç½²:"
          echo "   docker build -t mendian-frontend:$(git rev-parse --short HEAD) ."
          echo "   docker push registry/mendian-frontend:$(git rev-parse --short HEAD)"
          echo ""
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ (å ä½ç¬¦)"

      - name: ðŸ” éƒ¨ç½²åŽéªŒè¯
        run: |
          echo "è¿è¡Œéƒ¨ç½²åŽéªŒè¯..."
          echo "ç­‰å¾…æœåŠ¡ç¨³å®š..."
          sleep 10
          
          echo "ðŸ’¡ æ·»åŠ æ‚¨çš„å¥åº·æ£€æŸ¥å‘½ä»¤:"
          echo "   curl -f https://mendian.yourdomain.com/health"
          echo "   curl -f https://mendian.yourdomain.com/"
          
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéªŒè¯å®Œæˆ"

      - name: ðŸ“ ç”Ÿäº§éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && 'âœ… éƒ¨ç½²æˆåŠŸ' || 'âŒ éƒ¨ç½²å¤±è´¥' }}"
          
          echo "## ðŸ­ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **çŽ¯å¢ƒ**: production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://mendian.yourdomain.com" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: $STATUS" >> $GITHUB_STEP_SUMMARY

  # æ¸…ç†
  cleanup:
    name: ðŸ§¹ æ¸…ç†å’Œæ€»ç»“
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ðŸ“ æµæ°´çº¿æ‘˜è¦
        run: |
          echo "## ðŸŽ¨ å‰ç«¯ CI/CD æµæ°´çº¿æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œç¼–å·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ä»»åŠ¡ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»£ç è´¨é‡**: ${{ needs.quality.result || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•**: ${{ needs.test.result || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»º**: ${{ needs.build.result || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•çŽ¯å¢ƒ**: ${{ needs.deploy-staging.result || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿäº§çŽ¯å¢ƒ**: ${{ needs.deploy-production.result || 'è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "1. é…ç½®å®žé™…çš„éƒ¨ç½²å‘½ä»¤ (Netlify/Vercel/AWS/ç­‰)"  >> $GITHUB_STEP_SUMMARY
          echo "2. è®¾ç½®ç”Ÿäº§çŽ¯å¢ƒåŸŸåå’Œå¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "3. é…ç½®ç›‘æŽ§å’Œå‘Šè­¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ å‰ç«¯æµæ°´çº¿è¿è¡Œå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY