name: ğŸ³ Dockeréƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging

permissions:
  contents: read

concurrency:
  group: docker-test-deploy
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'
  IMAGE_NAME: mendian-frontend
  CONTAINER_NAME: mendian-test

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Dockeræ„å»ºå¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'test' }}
    
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ³ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ æ„å»º Docker é•œåƒ
        run: |
          echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
          
          # åˆ›å»ºä¼˜åŒ–çš„ Dockerfile
          cat > Dockerfile << 'EOF'
          # å¤šé˜¶æ®µæ„å»º - æ„å»ºé˜¶æ®µ
          FROM node:18-alpine AS builder
          
          WORKDIR /app
          
          # å®‰è£… pnpm
          RUN npm install -g pnpm@8.15.0
          
          # å¤åˆ¶ä¾èµ–æ–‡ä»¶
          COPY package*.json pnpm*.yaml ./
          COPY frontend/package*.json ./frontend/
          
          # å®‰è£…ä¾èµ–
          RUN pnpm install --frozen-lockfile
          
          # å¤åˆ¶æºç 
          COPY frontend ./frontend
          
          # æ„å»ºé¡¹ç›®
          WORKDIR /app/frontend
          RUN pnpm build
          
          # ç”Ÿäº§é˜¶æ®µ
          FROM nginx:alpine
          
          # å¤åˆ¶æ„å»ºæ–‡ä»¶
          COPY --from=builder /app/frontend/dist /usr/share/nginx/html
          
          # å¤åˆ¶ nginx é…ç½®
          COPY <<'NGINX_EOF' /etc/nginx/conf.d/default.conf
          server {
              listen 80;
              server_name localhost;
              root /usr/share/nginx/html;
              index index.html;
              
              # SPA è·¯ç”±æ”¯æŒ
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # é™æ€èµ„æºç¼“å­˜
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # å¥åº·æ£€æŸ¥
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
              
              # å®‰å…¨é…ç½®
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
          }
          NGINX_EOF
          
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
          # æ„å»ºé•œåƒ
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.IMAGE_NAME }}:latest
          
          echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"

      - name: ğŸ’¾ ä¿å­˜é•œåƒ
        run: |
          echo "ğŸ’¾ ä¿å­˜ Docker é•œåƒ..."
          docker save ${{ env.IMAGE_NAME }}:latest | gzip > mendian-image.tar.gz
          echo "âœ… é•œåƒå·²ä¿å­˜: mendian-image.tar.gz"
          ls -lah mendian-image.tar.gz

      - name: ğŸ“¤ ä¸Šä¼ é•œåƒåˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          source: "mendian-image.tar.gz"
          target: "/tmp/"

      - name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹ Docker éƒ¨ç½²..."
            
            # è®¾ç½®å˜é‡
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ vars.TEST_PORT || '8080' }}"
            
            # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨
            if docker ps -a | grep -q $CONTAINER_NAME; then
              echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
            fi
            
            # åˆ é™¤æ—§é•œåƒ
            if docker images | grep -q $IMAGE_NAME; then
              echo "ğŸ—‘ï¸ æ¸…ç†æ—§é•œåƒ..."
              docker rmi $IMAGE_NAME:latest || true
            fi
            
            # åŠ è½½æ–°é•œåƒ
            echo "ğŸ“¦ åŠ è½½æ–°é•œåƒ..."
            docker load < /tmp/mendian-image.tar.gz
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p $PORT:80 \
              --health-cmd="curl -f http://localhost/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              $IMAGE_NAME:latest
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/mendian-image.tar.gz
            
            echo "âœ… å®¹å™¨å¯åŠ¨å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.TEST_SERVER_HOST }}:$PORT"

      - name: ğŸ§ª å¥åº·æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸ§ª æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ vars.TEST_PORT || '8080' }}"
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if ! docker ps | grep -q $CONTAINER_NAME; then
              echo "âŒ å®¹å™¨æœªæ­£å¸¸è¿è¡Œ"
              docker logs $CONTAINER_NAME
              exit 1
            fi
            
            # HTTP å¥åº·æ£€æŸ¥
            for i in {1..10}; do
              if curl -f -s --max-time 10 "http://localhost:$PORT/health" > /dev/null; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i/10)"
                echo "ğŸ‰ Docker éƒ¨ç½²æˆåŠŸï¼"
                
                # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
                echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
                docker ps | grep $CONTAINER_NAME
                echo "ğŸ’¾ èµ„æºä½¿ç”¨:"
                docker stats --no-stream $CONTAINER_NAME
                break
              else
                echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (å°è¯• $i/10)"
                if [ $i -eq 10 ]; then
                  echo "âŒ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
                  echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
                  docker logs --tail 50 $CONTAINER_NAME
                  exit 1
                fi
                sleep 10
              fi
            done

      - name: ğŸ§¹ æ¸…ç†èµ„æº
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT || 22 }}
          script: |
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker èµ„æº..."
            docker system prune -f || true
            echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“‹ éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && 'âœ… éƒ¨ç½²æˆåŠŸ' || 'âŒ éƒ¨ç½²å¤±è´¥' }}"
          PORT="${{ vars.TEST_PORT || '8080' }}"
          
          echo "## ğŸ³ Docker æµ‹è¯•éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“Š çŠ¶æ€**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸŒ è®¿é—®åœ°å€**: http://${{ secrets.TEST_SERVER_HOST }}:$PORT" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ³ å®¹å™¨åç§°**: \`${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ é•œåƒ**: \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”¢ æ„å»ºç¼–å·**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ“¦ æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ğŸ‰ Docker éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”§ ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
            echo "- æŸ¥çœ‹æ—¥å¿—: \`docker logs ${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- é‡å¯å®¹å™¨: \`docker restart ${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- åœæ­¢å®¹å™¨: \`docker stop ${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æŸ¥çœ‹çŠ¶æ€: \`docker ps | grep ${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          fi