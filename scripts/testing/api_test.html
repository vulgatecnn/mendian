<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯APIæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #cf1322;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0958d9;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .status-card {
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .status-online {
            background: #f6ffed;
            border: 2px solid #52c41a;
        }
        .status-offline {
            background: #fff2f0;
            border: 2px solid #ff4d4f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é—¨åº—ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿ - å‰åç«¯æµ‹è¯•</h1>
        
        <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <div class="test-title">ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥</div>
            <button onclick="checkServices()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            <div class="status-grid" id="serviceStatus"></div>
        </div>

        <!-- APIè¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ”— APIè¿æ¥æµ‹è¯•</div>
            <button onclick="testApiDocs()">æµ‹è¯•APIæ–‡æ¡£</button>
            <button onclick="testApiSchema()">æµ‹è¯•API Schema</button>
            <button onclick="testApiPermissions()">æµ‹è¯•æƒé™API</button>
            <div id="apiResult" class="result info" style="display:none;"></div>
        </div>

        <!-- CORSæµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸŒ è·¨åŸŸ(CORS)æµ‹è¯•</div>
            <button onclick="testCors()">æµ‹è¯•è·¨åŸŸè¯·æ±‚</button>
            <div id="corsResult" class="result info" style="display:none;"></div>
        </div>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ” ç™»å½•åŠŸèƒ½æµ‹è¯•</div>
            <p>ç”¨æˆ·å: <input type="text" id="username" value="admin" style="padding:5px;"></p>
            <p>å¯†ç : <input type="password" id="password" value="admin123" style="padding:5px;"></p>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <div id="loginResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FRONTEND_BASE = 'http://localhost:5000';

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>';

            const services = [
                { name: 'åç«¯æœåŠ¡', url: `${API_BASE}/admin/`, port: '8000' },
                { name: 'å‰ç«¯æœåŠ¡', url: FRONTEND_BASE, port: '5000' },
                { name: 'APIæ–‡æ¡£', url: `${API_BASE}/api/docs/`, port: '8000' },
                { name: 'API Schema', url: `${API_BASE}/api/schema/`, port: '8000' }
            ];

            let statusHtml = '';
            
            for (const service of services) {
                try {
                    const response = await fetch(service.url, { 
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    statusHtml += `
                        <div class="status-card status-online">
                            <strong>${service.name}</strong><br>
                            ç«¯å£: ${service.port}<br>
                            <span style="color: #52c41a;">âœ… åœ¨çº¿</span>
                        </div>
                    `;
                } catch (error) {
                    statusHtml += `
                        <div class="status-card status-offline">
                            <strong>${service.name}</strong><br>
                            ç«¯å£: ${service.port}<br>
                            <span style="color: #ff4d4f;">âŒ ç¦»çº¿</span>
                        </div>
                    `;
                }
            }
            
            statusDiv.innerHTML = statusHtml;
        }

        // æµ‹è¯•APIæ–‡æ¡£
        async function testApiDocs() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•APIæ–‡æ¡£è®¿é—®...';

            try {
                const response = await fetch(`${API_BASE}/api/docs/`, {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… APIæ–‡æ¡£è®¿é—®æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nå¯ä»¥è®¿é—®: ${API_BASE}/api/docs/`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ APIæ–‡æ¡£è®¿é—®å¤±è´¥\nçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ APIæ–‡æ¡£è®¿é—®å‡ºé”™: ${error.message}`;
            }
        }

        // æµ‹è¯•API Schema
        async function testApiSchema() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•API Schema...';

            try {
                const response = await fetch(`${API_BASE}/api/schema/`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… API Schemaè·å–æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nå†…å®¹ç±»å‹: ${contentType}\nå¯ä»¥è®¿é—®: ${API_BASE}/api/schema/`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ API Schemaè·å–å¤±è´¥\nçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ API Schemaè·å–å‡ºé”™: ${error.message}`;
            }
        }

        // æµ‹è¯•æƒé™API
        async function testApiPermissions() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•æƒé™API...';

            try {
                const response = await fetch(`${API_BASE}/api/permissions/`);
                
                if (response.status === 403) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æƒé™APIæµ‹è¯•æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status} (éœ€è¦è®¤è¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„)\nè¯´æ˜: APIæ­£ç¡®è¦æ±‚èº«ä»½è®¤è¯`;
                } else if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æƒé™APIè®¿é—®æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nè¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ æƒé™APIæµ‹è¯•å¤±è´¥\nçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æƒé™APIæµ‹è¯•å‡ºé”™: ${error.message}`;
            }
        }

        // æµ‹è¯•CORS
        async function testCors() {
            const resultDiv = document.getElementById('corsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•è·¨åŸŸè¯·æ±‚...';

            try {
                const response = await fetch(`${API_BASE}/api/permissions/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': FRONTEND_BASE
                    }
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… CORSé…ç½®æ­£ç¡®ï¼\nçŠ¶æ€ç : ${response.status}\nè¯´æ˜: è·¨åŸŸè¯·æ±‚æˆåŠŸå‘é€ï¼Œåç«¯æ­£ç¡®å¤„ç†äº†CORSå¤´`;
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ CORSé…ç½®æœ‰é—®é¢˜: ${error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… CORSé…ç½®æ­£ç¡®ï¼\nè¯´æ˜: è¯·æ±‚è¢«æ­£ç¡®å¤„ç†ï¼Œé”™è¯¯æ˜¯ç”±äºæƒé™éªŒè¯å¼•èµ·çš„ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰`;
                }
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç™»å½•...';

            try {
                // é¦–å…ˆè·å–CSRF token
                const csrfResponse = await fetch(`${API_BASE}/admin/login/`);
                const csrfText = await csrfResponse.text();
                const csrfMatch = csrfText.match(/name='csrfmiddlewaretoken' value='([^']+)'/);
                
                if (!csrfMatch) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ æ— æ³•è·å–CSRF token';
                    return;
                }
                
                const csrfToken = csrfMatch[1];
                
                // å°è¯•ç™»å½•
                const loginResponse = await fetch(`${API_BASE}/admin/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                    },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&csrfmiddlewaretoken=${csrfToken}&next=/admin/`,
                    credentials: 'include'
                });
                
                if (loginResponse.ok && loginResponse.url.includes('/admin/')) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ç™»å½•æµ‹è¯•æˆåŠŸï¼\nç”¨æˆ·å: ${username}\nè¯´æ˜: å¯ä»¥ä½¿ç”¨æ­¤è´¦å·ç™»å½•ç®¡ç†åå°\nç®¡ç†åå°åœ°å€: ${API_BASE}/admin/`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ç™»å½•å¤±è´¥\nçŠ¶æ€ç : ${loginResponse.status}\nè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç `;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç™»å½•æµ‹è¯•å‡ºé”™: ${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.onload = function() {
            checkServices();
        };
    </script>
</body>
</html>
